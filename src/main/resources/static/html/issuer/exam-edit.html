<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>试卷编辑</title>
		<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
		<!--基础js-->
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
		<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<!--DateTimepicker-->
		<script src="https://cdn.bootcss.com/moment.js/2.24.0/moment-with-locales.js"></script>
		<script src="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
		<!--BootStrap Table-->
		<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>

	</head>
	<style>
        #question-table tr:nth-child(even) {
            background: #f4f8fb;
        }

        .black_overlay {

            display: none;
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            background-color: #c8c8c8;
            z-index: 1001;
            -moz-opacity: 0.8;
            opacity: .80;
            filter: alpha(opacity=78);
        }

        .pop_win {

            display: none;
            position: absolute;
            top: 10%;
            left: 23%;
            width: 55%;
            height: 75%;
            padding: 10px;
            /*border-radius: 36px 38px 49px 40px / 53px 47px 51px 54px;*/
            border: 2px solid cornflowerblue;
            background-color: white;
            z-index: 9999;
            overflow: auto;
        }
	</style>

	<body>
		<nav th:replace="../static/html/common/fragments.html::issuer_menu(3)"></nav>


		<div class="container">
			<form class="form" method="post" role="form">
				<h1 id="add-title">查看考试</h1>
				<br>
				<div class="form-group">
					<label for="exam-id">考试编号</label>
					<input type="text" id="exam-id" class="form-control" placeholder="这里什么都没有" disabled>
				</div>
				<div class="form-group">
					<label for="exam-name">考试名称</label>
					<input type="text" id="exam-name" class="form-control" placeholder="这里什么都没有" required autofocus>
				</div>
				<div class="form-group">
					<label for="exam-start-time">开始时间</label>
					<div class='input-group date form-date form_datetime' id='exam-start-time'>
						<input type='text' class="form-control" id="start_time"/>
						<span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
					</div>
				</div>
				<div class="form-group">
					<label for="exam-end-time">结束时间</label>
					<!--指定 date标记-->
					<div class='input-group date' id='exam-end-time'>
						<input type='text' class="form-control form_datetime" id="end_time"/>
						<span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
					</div>
				</div>
				<input type="hidden" th:value="${exam}" id="exam-questions"/>


				<div class="form-group" id="question-container">
					<label for="exam-questions">题目选择</label>
					<a href="#" class="btn btn-success btn-default" onclick="popWinToAdd()">
						<span class="glyphicon glyphicon-plus"></span> 问题添加
					</a>
					<table id="question-table" class="table" search="true">
					</table>
				</div>

				<input name="_csrf" type="hidden" value="93edbebc-aa90-4b8c-b372-28f922a9a9e6"/>
				<button class="btn btn-lg btn-primary btn-block" type="button" id="exam-update-btn" onclick="update()">
					保存问题
				</button>
			</form>
		</div>

		<!--悬浮修改窗口-->
		<div id="lightToEdit" class="pop_win">
			<button type="button" class="btn btn-danger" style="float: right" onclick="closeWin()">
				<span class="glyphicon glyphicon-remove"></span>
			</button>
			<form class="form" method="post" role="form">
				<h2 id="edit-title">问题编辑</h2>
				<div class="form-group">
					<label for="question-edit-id">题目编号</label>
					<input readonly="readonly" id="question-edit-id" type="text" class="form-control">
				</div>
				<div class="form-group">
					<label for="question-edit-type">题目类型</label>
					<select id="question-edit-type" class="form-control" onchange="changEditForm()">
						<option th:value="MULTIPLE_CHOICE">多选</option>
						<option th:value="SINGLE_CHOICE">单选</option>
						<option th:value="FILL_BLANK">填空</option>
						<option th:value="JUDGE">判断</option>
					</select>
				</div>
				<div class="form-group">
					<label for="question-info">题干</label>
					<input type="text" id="question-info" class="form-control" placeholder="题干" required autofocus>
				</div>
				<div class="form-group" id="question-edit-answer-A">
					<label for="answer">选项A</label>
					<input type="text"  class="form-control" placeholder="答案" required>
				</div>
				<div class="form-group" id="question-edit-answer-B">
					<label for="answer">选项B</label>
					<input type="text"  class="form-control" placeholder="答案" required>
				</div>
				<div class="form-group" id="question-edit-answer-C">
					<label for="answer">选项C</label>
					<input type="text"  class="form-control" placeholder="答案" required>
				</div>
				<div class="form-group" id="question-edit-answer-D">
					<label for="answer">选项D</label>
					<input type="text"  class="form-control" placeholder="答案" required>
				</div>
				<div class="form-group" id="question-edit-answer">
					<label for="answer">答案</label>
					<input type="text" id="answer" class="form-control" placeholder="答案" required>
				</div>
				<div class="form-group" id="question-edit-judge">
					<label for="question-edit-judge">题目正确性</label>
					<select  class="form-control">
						<option value="True">正确</option>
						<option value="False">错误</option>
					</select>
				</div>
				<div class="form-group">
					<label for="score">分值</label>
					<input type="text" id="score" class="form-control" placeholder="Score" required>
				</div>
				<div class="form-group">
					<label for="delete">是否弃用</label>
					<select id="delete" class="form-control">
						<option>是</option>
						<option>否</option>
					</select>
				</div>
				<input name="_csrf" type="hidden" value="93edbebc-aa90-4b8c-b372-28f922a9a9e6"/>
				<button class="btn btn-lg btn-primary btn-block" type="button" id="question-edit-btn">提交</button>
			</form>
		</div>
		<!--添加问题窗口-->
		<div id="lightToAdd" class="pop_win">
			<button type="button" class="btn btn-danger" style="float: right" onclick="closeWin()">
				<span class="glyphicon glyphicon-remove"></span>
			</button>
			<form class="form" method="post" role="form">
				<h2>试卷问题添加</h2>
				<div class="form-group">
					<label for="question-type">题目类型</label>
					<select id="question-add-type" class="form-control" onchange="changAddForm()">
						<option th:value="MULTIPLE_CHOICE">多选</option>
						<option th:value="SINGLE_CHOICE">单选</option>
						<option th:value="FILL_BLANK">填空</option>
						<option th:value="JUDGE">判断</option>
					</select>
				</div>
				<div class="form-group">
					<label for="question-add-info">题干</label>
					<input type="text" id="question-add-info" class="form-control" placeholder="题目大意" required
					       autofocus>
				</div>

				<div class="form-group" id="question-add-answer-A">
					<label for="answer">选项A</label>
					<input type="text"  class="form-control" placeholder="选项A" required>
				</div>
				<div class="form-group" id="question-add-answer-B">
					<label for="answer">选项B</label>
					<input type="text"  class="form-control" placeholder="选项B" required>
				</div>
				<div class="form-group" id="question-add-answer-C">
					<label for="answer">选项C</label>
					<input type="text"  class="form-control" placeholder="选项C" required>
				</div>
				<div class="form-group" id="question-add-answer-D">
					<label for="answer">选项D</label>
					<input type="text"  class="form-control" placeholder="选项D" required>
				</div>

				<div class="form-group" id="question-add-judge">
					<label for="question-add-judge">题目是否正确</label>
					<select  class="form-control">
						<option th:value="True">正确</option>
						<option th:value="False">错误</option>
					</select>
				</div>
				<div class="form-group">
					<label for="answer">答案</label>
					<input type="text" id="question-add-answer" class="form-control" placeholder="答案" required>
				</div>

				<div class="form-group">
					<label for="score">分值</label>
					<input type="text" id="question-add-score" class="form-control" placeholder="分数" required>
				</div>
				<input name="_csrf" type="hidden" value="93edbebc-aa90-4b8c-b372-28f922a9a9e6"/>
				<button class="btn btn-lg btn-primary btn-block" type="button" id="question-add-btn">保存试卷</button>
			</form>
		</div>
		<div id="fade" class="black_overlay"></div>


	</body>
	<script>
        /*数据回显*/
        var examValue = $("#exam-questions").val();
        let exam = JSON.parse(examValue);
        $("#exam-id").val(exam.id);
        $("#exam-name").val(exam.name);
        $("#start_time").val(exam.startTime);
        $("#end_time").val(exam.endTime);

        /*表格初始化*/
        $('#question-table').bootstrapTable({
            uniqueId: 'id',
            striped: true,
            search: true,
            showRefresh: true,
            showColumns: true,
            data: exam.questions,
            columns: [{
                field: 'id',
                title: '题目编号',
                sortable: true,
                sortOrder: "asc",
                align: "center",
                width: 30
            }, {
                field: 'infoTextContent',
                title: '问题题干',
                sortable: true,
                sortOrder: "asc",
                width: 360
            }, {
                field: 'type',
                title: '题目类型',
                width: 120,
                sortable: true,
                sortOrder: "asc",
                align: "center"
            }, {
                field: 'score',
                title: '分数',
                sortable: true,
                sortOrder: "asc",
                width: 60,
                align: "center"
            }, {
                field: 'id',
                title: '操作',
                width: 120,
                align: 'center',
                formatter: actionFormatter,
            }]
        });

        /*图标初始化*/
        function actionFormatter(value, row, index) {
            var id = value;
            var result = "";
            result += "<a href='javascript:;' class='btn btn-xs green' onclick=\"ViewQuestionById('" + id + "')\" title='查看'><span class='glyphicon glyphicon-search'></span></a>";
            result += "<a href='javascript:;' class='btn btn-xs red' onclick=\"DeleteQuestionByIds('" + id + "')\" title='删除'><span class='glyphicon glyphicon-remove'></span></a>";
            return result;
        }

        //问题表格中的查看按钮
        function ViewQuestionById(questionId) {
            $.getJSON('/questions/' + questionId, function (result) {
                popWinToEdit(result);
            })
        }

        //3、如果要删除项为对象，我们需要知道该对象属性中的唯一值（不会重复的值）
        //arr是源数组，attr是目标数组中的属性名称，value是要删除的属性名称对应的值
        var arrRemoveJson = function (arr, attr, value) {
            if (!arr || arr.length == 0) {
                return ""
            }
            let newArr = arr.filter(function (item, index) {
                return item[attr] != value
            })
            return newArr;
        }

        //问题表格中的删除按钮
        function DeleteQuestionByIds(questionId) {
            if (confirm("确定是否删除该问题?")) {
                exam.questions = arrRemoveJson(exam.questions, 'id', questionId);
                $.ajax({
                    url: '/questions/' + questionId,
                    type: "delete"
                }).done(function (data) {
                    location.reload();
                })
            }

        }

        //更新函数
        function update() {
            var st = $("#start_time").val();
            var et = $("#end_time").val();
            let formData = JSON.stringify({
                "id": $("#exam-id").val(),
                "name": $("#exam-name").val(),
                "questions": exam.questions,
                "startTime": $("#start_time").val(),
                "endTime": $("#end_time").val()
            });
            $.ajax({
                url: "/issuer/updateExam",
                type: "post",
                contentType: "application/json",
                data: formData,
                dataType: "json"
            }).done(function (data) {
                console.log(data.code);
                if (data.code == 200) {
                    alert("保存成功");
                    location.reload();
                } else alert("保存失败！");
            })
        }

        $('#exam-start-time').datetimepicker({
            format: 'YYYY-MM-DD hh:mm:ss',
            locale: moment.locale('zh-cn')
        });
        $('#exam-end-time').datetimepicker({
            format: 'YYYY-MM-DD hh:mm:ss',
            locale: moment.locale('zh-cn')
        });

        //编辑窗口提交操作
        $("#question-add-btn").click(function () {
            // alert("点了我！")
            let questionToAdd = JSON.stringify({
                "infoTextContent": $("#question-add-info").val(),
                "score": $("#question-add-score").val(),
                "option1":$("#question-edit-answer-A").val(),
                "option2":$("#question-edit-answer-B").val(),
                "option3":$("#question-edit-answer-C").val(),
                "option4":$("#question-edit-answer-D").val(),
                "type": $("#question-add-type").val(),
                "correctAnswer": $("#question-add-answer").val(),
                "deleted": $("#canUse").val() == "是" ? false : true
            });
            let s = JSON.stringify(exam.questions);
            if (s.length == 2) s = s.substr(0, s.length - 1) + questionToAdd + ']';
            else s = s.substr(0, s.length - 1) + ',' + questionToAdd + ']';
            exam.questions = JSON.parse(s);
            update();
            closeWin();
        })

        //编辑窗口修改操作
        $("#question-edit-btn").click(function () {
            var question_id = $("#question-edit-id").val();
            // alert("点了我！")
            let formData = JSON.stringify({
                "id": $("#question-edit-id").val(),
                "infoTextContent": $("#question-info").val(),
                "option1":$("#question-edit-answer-A").val(),
                "option2":$("#question-edit-answer-B").val(),
                "option3":$("#question-edit-answer-C").val(),
                "option4":$("#question-edit-answer-D").val(),
                "score": $("#score").val(),
                "type": $("#question-edit-type").val(),
                "correctAnswer": $("#answer").val(),
                "deleted": $("#delete").val() == "是" ? true : false,
            })
            // console.log(typeof formData.id);
            $.ajax({
                url: "/questions/" + question_id,
                type: "put",
                contentType: "application/json",
                data: formData,
                dataType: "json"
            }).done(function (data) {
                console.log(data.code);
                if (data.code == 200) {
                    alert("修改成功");
                    location.reload();
                } else alert("修改失败！");
            })
        })

        /*窗口弹出添加修改函数*/
        function popWinToAdd() {
            document.getElementById('lightToAdd').style.display = 'block';
            document.getElementById('fade').style.display = 'block';
            changAddForm();
        }

        /*窗口弹出编辑函数*/
        function popWinToEdit(question) {
            document.getElementById("edit-title").innerText = "编辑问题" + question.data.id;
            $("#question-edit-id").val(question.data.id);
            $("#question-type").val(question.data.type);
            $("#question-info").val(question.data.infoTextContent);
            $("#answer").val(question.data.correctAnswer);
            $("#score").val(question.data.score);
            $("#delete").val((question.data.deleted) ? "是" : "否");
            document.getElementById('lightToEdit').style.display = 'block';
            document.getElementById('fade').style.display = 'block'
            changEditForm();
        }

        function flash() {
            console.log("faf");
            $('#bootstrap-table').bootstrapTable('destroy');
            $('#question-table').bootstrapTable('refresh');
        }

        /*窗口关闭函数*/
        function closeWin() {
            document.getElementById('lightToEdit').style.display = 'none';
            document.getElementById('lightToAdd').style.display = 'none';
            document.getElementById('fade').style.display = 'none';
            $('#question-table').bootstrapTable('refresh');
        }

        //根据题目类型来调整表单
        function changEditForm(){
            var type = $("#question-edit-type").val();
            // alert("当前选项"+ $("#question--type").val());
            console.log(type);
            if(type == 'MULTIPLE_CHOICE' || type == "SINGLE_CHOICE") {
                $("#question-edit-answer").show();
                $("#question-edit-answer-A").show();
                $("#question-edit-answer-B").show();
                $("#question-edit-answer-C").show();
                $("#question-edit-answer-D").show();
                $("#question-edit-judge").hide();
            }else if(type == 'FILL_BLANK'){
                $("#question-edit-answer").show();
                $("#question-edit-answer-A").hide();
                $("#question-edit-answer-B").hide();
                $("#question-edit-answer-C").hide();
                $("#question-edit-answer-D").hide();
                $("#question-edit-judge").hide();
            }else{
                $("#question-edit-answer").hide();
                $("#question-edit-answer-A").hide();
                $("#question-edit-answer-B").hide();
                $("#question-edit-answer-C").hide();
                $("#question-edit-answer-D").hide();
                $("#question-edit-judge").show();
            }
        }

        //根据题目类型来调整表单
        function changAddForm(){
            var type = $("#question-add-type").val();
            console.log(type);
            if(type == 'MULTIPLE_CHOICE' || type == "SINGLE_CHOICE") {
                $("#question-add-answer").show();
                $("#question-add-answer-A").show();
                $("#question-add-answer-B").show();
                $("#question-add-answer-C").show();
                $("#question-add-answer-D").show();
                $("#question-add-judge").hide();
            }else if(type == 'FILL_BLANK'){
                $("#question-add-answer").show();
                $("#question-add-answer-A").hide();
                $("#question-add-answer-B").hide();
                $("#question-add-answer-C").hide();
                $("#question-add-answer-D").hide();
                $("#question-add-judge").hide();
            }else{
                $("#question-add-answer").hide();
                $("#question-add-answer-A").hide();
                $("#question-add-answer-B").hide();
                $("#question-add-answer-C").hide();
                $("#question-add-answer-D").hide();
                $("#question-add-judge").show();
            }
        }
	</script>
</html>
